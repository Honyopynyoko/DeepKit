/*
 * Deepkit Framework
 * Copyright (C) 2021 Deepkit UG, Marc J. Schmidt
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the MIT License.
 *
 * You should have received a copy of the MIT License along with this program.
 */
import { Changes, getClassSchema, getClassTypeFromInstance } from '@deepkit/type';
import sift from 'sift';
import { getInstanceStateFromItem } from './identity-map';
export function getClassSchemaInstancePairs(items) {
    const map = new Map();
    for (const item of items) {
        const classSchema = getClassSchema(getClassTypeFromInstance(item));
        let items = map.get(classSchema);
        if (!items) {
            items = [];
            map.set(classSchema, items);
        }
        items.push(item);
    }
    return map;
}
export function findQuerySatisfied(target, query) {
    //get rid of "Excessive stack depth comparing types 'any' and 'SiftQuery<T[]>'."
    return sift(query, [target]).length > 0;
}
export function findQueryList(items, query) {
    //get rid of "Excessive stack depth comparing types 'any' and 'SiftQuery<T[]>'."
    return sift(query, items);
}
export function buildChangesFromInstance(item) {
    const state = getInstanceStateFromItem(item);
    const lastSnapshot = state.getSnapshot();
    const currentSnapshot = state.classState.snapshot(item);
    console.log(item, state.classState.classSchema.getClassName(), state.item === item, lastSnapshot, currentSnapshot);
    return state.classState.changeDetector(lastSnapshot, currentSnapshot, item) || new Changes;
}
//# sourceMappingURL=utils.js.map